<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="/images/logo.png" type="image/png">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" type="text/css" href="../css/table-main.css"/>
    <style>
        img {
            object-fit: cover;
            width: 100px;
            height: 100px;
        }
    </style>
</head>
<body>
<a href="/Product/product-create.html" id="add-products"> Add Products</a>
<label for="search">Search</label>
<input onkeyup="filterProducts()" type="text" name="search" id="search"
       placeholder="search for book title, author or id">
<select name="category" id="category" onchange="filterProducts()">
    <option selected value>Choose Category</option>
    <option value="Adventure stories">Adventure stories</option>
    <option value="Classics">Classics</option>
    <option value="Crime">Crime</option>
    <option value="Fairy tales, fables, and folk tales">Fairy tales, fables, and folk tales</option>
    <option value="Fantasy">Fantasy</option>
    <option value="Historical fiction">Historical fiction</option>
    <option value="Horror">Horror</option>
    <option value="Humour and satire">Humour and satire</option>
    <option value="Literary fiction">Literary fiction</option>
    <option value="Mystery">Mystery</option>
    <option value="Poetry">Poetry</option>
    <option value="Plays">Plays</option>
    <option value="Romance">Romance</option>
    <option value="Science fiction">Science fiction</option>
    <option value="Short stories">Short stories</option>
    <option value="Thrillers">Thrillers</option>
    <option value="War">War</option>
    <option value="Women’s fiction">Women’s fiction</option>
    <option value="Young adult">Young adult</option>
</select>
<table id="table"></table>
<script>

    const headers = ['productId', 'title', 'author', 'publishDate', 'category', 'description', "image"];
    let products, role;

    fetchProducts();

    document.addEventListener("DOMContentLoaded", handleUserRole);

    function handleUserRole() {
        const prevURL = document.referrer;
        if (prevURL.toLowerCase().includes("customer")) role = "customer";
        else role = "admin"
        if (role === "customer") {
            const addLink = document.getElementById("add-products")
            addLink.style.display = "none";
        }
    }

    async function deleteProduct(productId) {
        try {
            const response = await fetch(`/product/${productId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                window.alert("Deleted Successfully");
                await fetchProducts();
            } else {
                const errorData = await response.json();
                window.alert('Delete Product failed: ' + errorData.message);
            }
        } catch (error) {
            console.error('Error deleting product:', error);
            window.alert('An error occurred. Please try again.');
        }
    }

    async function populateData(headers, data) {
        const table = document.getElementById("table");
        // clear table
        table.innerHTML = "";
        if (data.length === 0) {
            const noData = document.createElement("p");
            noData.innerHTML = "No Data Found";
            table.append(noData);
        }

        const thead = document.createElement("thead");
        const tr = document.createElement("tr")
        for (let i = 0; i <= headers.length - 1; i++) {
            const td = document.createElement("th")
            td.innerHTML = headers[i];
            tr.append(td);
        }
        thead.append(tr);
        table.append(thead);
        const tbody = document.createElement("tbody");
        for (let j = 0; j <= data.length - 1; j++) {
            const tr2 = document.createElement("tr")
            for (let i = 0; i <= headers.length - 1; i++) {
                const td = document.createElement("td")
                if (headers[i] === "image") {
                    const image = document.createElement("img")
                    image.src = data[j][headers[i]];
                    td.append(image);
                } else {
                    td.innerHTML = data[j][headers[i]];
                }
                tr2.append(td);
            }

            // append view
            const td2 = document.createElement("td")
            const view = document.createElement("a")
            view.href = `/Product/product-view.html?id=${data[j].productId}`
            view.innerHTML = "view";
            td2.append(view)
            tr2.append(td2);

            // if customer then exclude action buttons
            if (role === "customer") {
                tbody.append(tr2);
                continue;
            }

            // append edit and delete button
            const td3 = document.createElement("td")
            const edit = document.createElement("a")
            edit.href = `/Product/product-edit.html?id=${data[j].productId}`
            edit.innerHTML = "edit";
            td3.append(edit)
            const td4 = document.createElement("td")
            const del = document.createElement("button")
            del.onclick = () => deleteProduct(data[j].productId);
            del.innerHTML = "delete";
            td4.append(del)

            //append action buttons to row
            tr2.append(td3);
            tr2.append(td4);
            tbody.append(tr2)
        }
        table.append(tbody);
    }

    async function fetchProducts() {
        try {
            const response = await fetch('/products', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const responseData = await response.json();
                console.log({responseData})
                products = Object.freeze(responseData);
                await filterProducts();
            } else {
                const errorData = await response.json();
                window.alert('Fetch Product failed: ' + errorData.message);
            }
        } catch (error) {
            console.error('Error during login:', error);
            window.alert('An error occurred. Please try again.');
        }
    }

    async function filterProducts() {
        const searchInput = document.getElementById("search").value;
        const categorySelect = document.getElementById(("category")).value;

        console.log(searchInput, categorySelect, products);
        if (searchInput === "" && categorySelect === "")
            return await populateData(headers, products);
        const filteredProducts = products.filter(product => {
                return (product.title.includes(searchInput) || product.author.includes(searchInput)) && product.category.includes(categorySelect);
            }
        )
        console.log({filteredProducts});
        await populateData(headers, filteredProducts);
    }
</script>
</body>
</html>